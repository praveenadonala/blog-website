"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const node_path_1 = require("node:path");
const promises_1 = require("node:fs/promises");
// patch targets
// cjs: const interfaces_1 = require("./interfaces.js");
// esm: import { EjvError } from './interfaces.js';
console.log('* add-js-extensions');
(async () => {
    // get all .js file in build folder
    const buildFolder = (0, node_path_1.join)('.', 'build');
    const folderNames = (await (0, promises_1.readdir)(buildFolder, { withFileTypes: true }))
        .filter((one) => one.isDirectory())
        .map((one) => one.name);
    const importStateRegExp = /['"]\.\/[a-z]+['"]/g;
    let modifiedFileCount = 0;
    let modifiedStrCount = 0;
    for await (const folder of folderNames) {
        const jsFilePaths = (await (0, promises_1.readdir)((0, node_path_1.join)(buildFolder, folder), { withFileTypes: true }))
            .filter((one) => one.isFile() && one.name.endsWith('.js'))
            .map((one) => (0, node_path_1.join)(buildFolder, folder, one.name));
        for await (const jsFilePath of jsFilePaths) {
            let fileContents = await (0, promises_1.readFile)(jsFilePath, {
                encoding: 'utf-8'
            });
            const matchResults = [...fileContents.matchAll(importStateRegExp)];
            if (matchResults.length > 0) {
                for (let i = 0; i < matchResults.length; i++) {
                    const oneResult = matchResults[i];
                    const beforeStr = oneResult[0];
                    const afterStr = beforeStr.endsWith('"')
                        ? beforeStr.replace(/"$/, '.js"')
                        : beforeStr.replace(/'$/, '.js\'');
                    fileContents = fileContents.replace(beforeStr, afterStr);
                    ++modifiedStrCount;
                }
                await (0, promises_1.writeFile)(jsFilePath, fileContents, {
                    encoding: 'utf-8'
                });
                ++modifiedFileCount;
            }
        }
    }
    console.log(`${modifiedStrCount} import statements in ${modifiedFileCount} files patched`);
})();
//# sourceMappingURL=add-js-extensions.js.map